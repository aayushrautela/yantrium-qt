name: Build Flatpak (Manual)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-flatpak:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flatpak
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder

    - name: Install KDE Platform runtime and SDK
      run: |
        # Added sudo here to fix permission error
        sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
        sudo flatpak install -y flathub org.kde.Platform//6.10 org.kde.Sdk//6.10

    - name: Setup build environment
      env:
        TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
        TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
        OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      run: |
        # Export variables for envsubst
        export TMDB_API_KEY
        export TRAKT_CLIENT_ID
        export TRAKT_CLIENT_SECRET
        export OMDB_API_KEY

        # Install gettext for envsubst
        sudo apt-get install -y gettext-base

        # Inject API keys into manifest
        envsubst < org.yantrium.Yantrium.yml > org.yantrium.Yantrium.filled.yml

    - name: Build Flatpak
      run: |
        # Note: --install-deps-from=flathub is often helpful here, 
        # but since you installed the SDK manually above, this should work as is.
        flatpak-builder \
          --force-clean \
          --repo=repo \
          build-dir \
          org.yantrium.Yantrium.filled.yml

    - name: Create Flatpak bundle
      run: |
        flatpak build-bundle repo yantrium.flatpak org.yantrium.Yantrium

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Yantrium-Flatpak-${{ inputs.build_type }}
        path: |
          yantrium.flatpak
          org.yantrium.Yantrium.filled.yml
        retention-days: 30
        if-no-files-found: warn

    - name: Cleanup
      if: always()
      run: |
        rm -f org.yantrium.Yantrium.filled.yml