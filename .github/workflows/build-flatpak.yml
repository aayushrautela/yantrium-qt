name: Build Flatpak (Manual)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    env:
      MDK_VERSION: "0.35.0"
      FLATPAK_BUILDER_CACHE: ".flatpak-builder"
      MDK_PATH: "vendor/mdk-sdk"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flatpak and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder gettext-base
          
          # Setup Flathub and install KDE Runtimes
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.kde.Platform//6.10 org.kde.Sdk//6.10

      - name: Cache MDK SDK
        id: cache-mdk
        uses: actions/cache@v4
        with:
          path: ${{ env.MDK_PATH }}
          key: mdk-sdk-linux-${{ env.MDK_VERSION }}

      - name: Download MDK SDK
        if: steps.cache-mdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ${{ env.MDK_PATH }}
          DOWNLOAD_URL="https://github.com/wang-bin/mdk-sdk/releases/download/v${MDK_VERSION}/mdk-sdk-linux-x64.tar.xz"
          
          echo "Downloading MDK SDK v${MDK_VERSION}..."
          curl -L -f -o mdk-sdk.tar.xz "${DOWNLOAD_URL}"
          
          echo "Extracting..."
          tar -xf mdk-sdk.tar.xz -C ${{ env.MDK_PATH }} --strip-components=1
          rm -f mdk-sdk.tar.xz

      - name: Cache Flatpak Builder (Libtorrent/Boost)
        uses: actions/cache@v4
        with:
          # Cache the internal builder directory where compiled modules are stored
          path: .flatpak-builder
          # Update this key if you change boost/libtorrent versions to force a rebuild
          key: flatpak-builder-${{ runner.os }}-kde6.10-boost-1.84-libtorrent-v2.0.10
          restore-keys: |
            flatpak-builder-${{ runner.os }}-kde6.10-

      - name: Prepare Manifest
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
          TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          envsubst < org.yantrium.Yantrium.yml > org.yantrium.Yantrium.filled.yml

      - name: Build Flatpak
        run: |
          # --ccache: Enables ccache if available (speeds up C++ rebuilds)
          # --force-clean: Cleans the output directory (build-dir) but NOT the cache (.flatpak-builder)
          # --disable-updates: Prevents checking for updates to runtime/sdk
          flatpak-builder \
            --repo=repo \
            --force-clean \
            --disable-updates \
            --ccache \
            build-dir \
            org.yantrium.Yantrium.filled.yml

      - name: Create Bundle
        run: |
          flatpak build-bundle repo yantrium.flatpak org.yantrium.Yantrium

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Yantrium-Flatpak-${{ inputs.build_type }}
          path: yantrium.flatpak
          retention-days: 30