name: Build Windows (Manual)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      MDK_VERSION: "0.35.0"
      MDK_PATH: "vendor/mdk-sdk"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.3'
          arch: 'win64_msvc2019_64'
          cache: 'true'
          set-env: 'true'
          modules: 'qt5compat qtshadertools qtimageformats'

      - name: Setup Environment (MSVC, CMake, 7-Zip)
        uses: microsoft/setup-msbuild@v1.1
      
      - uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: '3.31'

      # Cache MDK SDK to avoid redownloading/extracting on every run
      - name: Cache MDK SDK
        id: cache-mdk
        uses: actions/cache@v4
        with:
          path: ${{ env.MDK_PATH }}
          key: mdk-sdk-windows-${{ env.MDK_VERSION }}

      - name: Download MDK SDK
        if: steps.cache-mdk.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path ${{ env.MDK_PATH }} | Out-Null
          $downloadUrl = "https://github.com/wang-bin/mdk-sdk/releases/download/v${{ env.MDK_VERSION }}/mdk-sdk-windows-desktop-vs2022-x64.7z"
          $archive = "mdk-sdk.7z"

          Write-Host "Downloading MDK SDK..."
          Invoke-WebRequest -Uri $downloadUrl -OutFile $archive -UseBasicParsing
          
          Write-Host "Extracting..."
          7z x $archive -o"${{ env.MDK_PATH }}" -y
          
          # Move contents up if they are nested in a single subdirectory
          $subdirs = Get-ChildItem -Path ${{ env.MDK_PATH }} -Directory
          if ($subdirs.Count -eq 1) {
            Get-ChildItem -Path $subdirs[0].FullName | Move-Item -Destination ${{ env.MDK_PATH }} -Force
            Remove-Item $subdirs[0].FullName -Force
          }
          Remove-Item $archive -Force

      # Cache Libtorrent (built via vcpkg)
      - name: Cache vcpkg and libtorrent
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: |
            vcpkg/
            vendor/libtorrent/
          key: vcpkg-libtorrent-${{ runner.os }}-v2

      - name: Build libtorrent with vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          git clone https://github.com/Microsoft/vcpkg.git vcpkg
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install libtorrent:x64-windows

          # Prepare vendor structure
          $vendorDir = "..\vendor\libtorrent"
          New-Item -ItemType Directory -Force -Path "$vendorDir\bin\x64", "$vendorDir\lib\x64", "$vendorDir\include" | Out-Null

          Copy-Item "installed\x64-windows\bin\*.dll" "$vendorDir\bin\x64\" -Force
          Copy-Item "installed\x64-windows\lib\*.lib" "$vendorDir\lib\x64\" -Force
          Copy-Item "installed\x64-windows\include\*" "$vendorDir\include\" -Recurse -Force

      - name: Convert SVG to ICO
        shell: powershell
        run: |
          choco install imagemagick --no-progress -y
          $iconDir = "resources\assets\icons"
          if (Test-Path "$iconDir\app_logo.svg") {
             magick "$iconDir\app_logo.svg" -define icon:auto-resize=16,32,48,64,128,256 "$iconDir\app_logo.ico"
          }

      - name: Configure and Build
        shell: cmd
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
          TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          cmake -B build -S . -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} ^
            -DTMDB_API_KEY="%TMDB_API_KEY%" ^
            -DTRAKT_CLIENT_ID="%TRAKT_CLIENT_ID%" ^
            -DTRAKT_CLIENT_SECRET="%TRAKT_CLIENT_SECRET%" ^
            -DOMDB_API_KEY="%OMDB_API_KEY%"
          
          cmake --build build --config ${{ inputs.build_type }}

      - name: Install OpenSSL
        shell: powershell
        run: |
          choco install openssl --no-progress
          $openssl = "C:\Program Files\OpenSSL-Win64\bin"
          if (-not (Test-Path $openssl)) { $openssl = "C:\Program Files\OpenSSL\bin" }
          
          $target = "build\${{ inputs.build_type }}"
          Copy-Item "$openssl\libcrypto*.dll", "$openssl\libssl*.dll" -Destination $target -Force

      - name: Deploy Qt and Plugins
        shell: powershell
        run: |
          $buildDir = "build\${{ inputs.build_type }}"
          $exePath = "$buildDir\Yantrium.exe"
          
          # 1. Standard Windeployqt
          windeployqt.exe --verbose 1 --qmldir resources/qml --compiler-runtime $exePath

          # 2. Manual Plugin Fixups (Streamlined)
          $qtBin = Split-Path (Get-Command windeployqt).Path -Parent
          $qtPlugins = Join-Path (Split-Path $qtBin -Parent) "plugins"
          
          # Copy extra dependencies from Qt bin (libwebp, etc) excluding core Qt dlls
          Get-ChildItem "$qtBin\*.dll" -Exclude "Qt6*.dll", "*d.dll" | Copy-Item -Destination $buildDir -Force

          # Function to force copy plugins to both root and ./plugins/ folder
          function Copy-PluginDir($name) {
             $src = Join-Path $qtPlugins $name
             if (Test-Path $src) {
                $destRoot = Join-Path $buildDir $name
                $destSub  = Join-Path $buildDir "plugins\$name"
                New-Item -Force -ItemType Directory $destRoot, $destSub | Out-Null
                
                Get-ChildItem "$src\*.dll" -Exclude "*d.dll" | ForEach-Object {
                   Copy-Item $_.FullName $destRoot -Force
                   Copy-Item $_.FullName $destSub -Force
                }
             }
          }

          Copy-PluginDir "imageformats"
          Copy-PluginDir "iconengines"
          Copy-PluginDir "tls"
          Copy-PluginDir "styles"

          # 3. Clean qt.conf to enforce standard paths
          Remove-Item "$buildDir\qt.conf" -Force -ErrorAction SilentlyContinue

      - name: Copy Runtime Dependencies
        shell: powershell
        run: |
          $target = "build\${{ inputs.build_type }}"
          Copy-Item "vendor\mdk-sdk\bin\x64\*.dll" $target -Force
          Copy-Item "vendor\libtorrent\bin\x64\*.dll" $target -Force

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Yantrium-Windows-${{ inputs.build_type }}
          path: |
            build/${{ inputs.build_type }}/
            !build/${{ inputs.build_type }}/**/*.obj
            !build/${{ inputs.build_type }}/**/*.iobj
            !build/${{ inputs.build_type }}/**/*.ipdb
            !build/${{ inputs.build_type }}/**/*.pdb
            !build/${{ inputs.build_type }}/**/*.exp
            !build/${{ inputs.build_type }}/**/*.lib
            !build/${{ inputs.build_type }}/**/*.ilk
          retention-days: 30