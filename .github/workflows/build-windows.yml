name: Build Windows (Manual)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install aqtinstall
      run: |
        pip install aqtinstall
        
    - name: Setup Qt6 (base installation)
      shell: cmd
      run: |
        python -m aqt install-qt windows desktop 6.6.3 win64_msvc2019_64 --outputdir "%TEMP%\Qt"
        
    - name: Set Qt6 environment for CMake
      shell: cmd
      run: |
        set QT6_DIR=%TEMP%\Qt\6.6.3\msvc2019_64
        echo Qt6_DIR=%QT6_DIR% >> %GITHUB_ENV%
        echo %QT6_DIR%\bin >> %GITHUB_PATH%
        
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.31'
        
    - name: Configure CMake
      shell: cmd
      env:
        TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
        TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
        OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      run: |
        set QT6_DIR=%TEMP%\Qt\6.6.3\msvc2019_64
        cmake -B build -S . ^
          -G "Visual Studio 17 2022" ^
          -A x64 ^
          -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} ^
          -DQt6_DIR="%QT6_DIR%\lib\cmake\Qt6" ^
          -DTMDB_API_KEY="%TMDB_API_KEY%" ^
          -DTRAKT_CLIENT_ID="%TRAKT_CLIENT_ID%" ^
          -DTRAKT_CLIENT_SECRET="%TRAKT_CLIENT_SECRET%" ^
          -DOMDB_API_KEY="%OMDB_API_KEY%"
          
    - name: Build
      shell: cmd
      run: |
        cmake --build build --config ${{ inputs.build_type }}
        
    - name: Check for MDK SDK Windows binaries
      shell: cmd
      run: |
        if not exist "vendor\mdk-sdk\lib\x64\mdk.lib" (
          echo "Warning: MDK SDK Windows library not found at vendor\mdk-sdk\lib\x64\mdk.lib"
          echo "Build may fail if MDK SDK is required."
        )
        if not exist "vendor\mdk-sdk\bin\x64" (
          echo "Warning: MDK SDK Windows binaries directory not found at vendor\mdk-sdk\bin\x64"
        )
        
    - name: Deploy Qt dependencies
      shell: cmd
      run: |
        if exist "build\${{ inputs.build_type }}\Yantrium.exe" (
          windeployqt.exe build\${{ inputs.build_type }}\Yantrium.exe
        ) else (
          echo "Executable not found, skipping windeployqt"
        )
        
    - name: Copy MDK DLLs
      shell: cmd
      run: |
        if exist "vendor\mdk-sdk\bin\x64\*.dll" (
          echo "Copying MDK DLLs..."
          copy /Y vendor\mdk-sdk\bin\x64\*.dll build\${{ inputs.build_type }}\
        ) else (
          echo "No MDK DLLs found to copy"
        )
        
    - name: List build artifacts
      shell: cmd
      run: |
        echo "Build artifacts:"
        dir /B build\${{ inputs.build_type }}\
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Yantrium-Windows-${{ inputs.build_type }}
        path: |
          build/${{ inputs.build_type }}/Yantrium.exe
          build/${{ inputs.build_type }}/*.dll
        retention-days: 30
        if-no-files-found: warn

