name: Build Windows (Manual)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Qt6
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.6.3'
        arch: 'win64_msvc2019_64'
        cache: 'true'
        set-env: 'true'
        modules: 'qt5compat qtshadertools'
        
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.31'
        
    - name: Configure CMake
      shell: cmd
      env:
        TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
        TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
        OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      run: |
        cmake -B build -S . ^
          -G "Visual Studio 17 2022" ^
          -A x64 ^
          -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} ^
          -DTMDB_API_KEY="%TMDB_API_KEY%" ^
          -DTRAKT_CLIENT_ID="%TRAKT_CLIENT_ID%" ^
          -DTRAKT_CLIENT_SECRET="%TRAKT_CLIENT_SECRET%" ^
          -DOMDB_API_KEY="%OMDB_API_KEY%"
          
    - name: Build
      shell: cmd
      run: |
        cmake --build build --config ${{ inputs.build_type }}
        
    - name: Check for MDK SDK Windows binaries
      shell: cmd
      run: |
        if not exist "vendor\mdk-sdk\lib\x64\mdk.lib" (
          echo "Warning: MDK SDK Windows library not found at vendor\mdk-sdk\lib\x64\mdk.lib"
          echo "Build may fail if MDK SDK is required."
        )
        if not exist "vendor\mdk-sdk\bin\x64" (
          echo "Warning: MDK SDK Windows binaries directory not found at vendor\mdk-sdk\bin\x64"
        )
        
    - name: Deploy Qt dependencies
      shell: cmd
      run: |
        if exist "build\${{ inputs.build_type }}\Yantrium.exe" (
          echo "Running windeployqt with QML directory and compiler runtime..."
          windeployqt.exe --qmldir resources/qml --compiler-runtime build\${{ inputs.build_type }}\Yantrium.exe
          echo "Qt deployment completed"
        ) else (
          echo "Executable not found, skipping windeployqt"
          exit /b 1
        )
        
    - name: Verify Qt deployment
      shell: cmd
      run: |
        echo "Verifying Qt deployment..."
        if exist "build\${{ inputs.build_type }}\platforms" (
          echo "Platforms directory found:"
          dir /B build\${{ inputs.build_type }}\platforms
        ) else (
          echo "ERROR: platforms directory not found!"
          exit /b 1
        )
        if exist "build\${{ inputs.build_type }}\platforms\qwindows.dll" (
          echo "SUCCESS: qwindows.dll found!"
        ) else (
          echo "ERROR: qwindows.dll not found in platforms directory!"
          exit /b 1
        )
        
    - name: Copy SQL plugins
      shell: powershell
      run: |
        Write-Host "Copying SQL plugins..."
        $windeployqt = Get-Command windeployqt -ErrorAction SilentlyContinue
        if (-not $windeployqt) {
          Write-Host "ERROR: windeployqt not found in PATH"
          exit 1
        }
        $windeployqtPath = $windeployqt.Path
        Write-Host "windeployqt found at: $windeployqtPath"
        
        # Resolve the path: windeployqt is in bin/, plugins are in plugins/
        $qtBinDir = Split-Path -Parent $windeployqtPath
        $qtRootDir = Split-Path -Parent $qtBinDir
        $sqlPluginsDir = Join-Path $qtRootDir "plugins\sqldrivers"
        
        Write-Host "Looking for SQL plugins at: $sqlPluginsDir"
        
        $sqliteDll = Join-Path $sqlPluginsDir "qsqlite.dll"
        if (Test-Path $sqliteDll) {
          $targetDir = "build\${{ inputs.build_type }}\sqldrivers"
          if (-not (Test-Path $targetDir)) {
            New-Item -ItemType Directory -Path $targetDir | Out-Null
          }
          Copy-Item -Path $sqliteDll -Destination $targetDir -Force
          Write-Host "SUCCESS: SQLite plugin copied to $targetDir"
        } else {
          Write-Host "ERROR: qsqlite.dll not found at $sqlPluginsDir"
          exit 1
        }
        
    - name: Setup and Copy OpenSSL
      shell: powershell
      run: |
        Write-Host "Installing OpenSSL 3 via Chocolatey..."
        choco install openssl --no-progress
        
        $opensslPath = "C:\Program Files\OpenSSL-Win64\bin"
        $targetDir = "build\${{ inputs.build_type }}"
        
        Write-Host "Looking for OpenSSL at: $opensslPath"
        
        # Qt 6.6+ on Windows requires OpenSSL 3
        # We need to copy libcrypto-3-x64.dll and libssl-3-x64.dll
        $dlls = @("libcrypto-3-x64.dll", "libssl-3-x64.dll")
        
        foreach ($dll in $dlls) {
          $source = Join-Path $opensslPath $dll
          if (Test-Path $source) {
            Copy-Item -Path $source -Destination $targetDir -Force
            Write-Host "SUCCESS: Copied $dll"
          } else {
            Write-Host "ERROR: Could not find $dll at $source"
            # Fallback: Try finding without -x64 suffix (using single quotes to fix syntax)
            $fallback = Join-Path $opensslPath ($dll -replace '-x64','')
            if (Test-Path $fallback) {
               Copy-Item -Path $fallback -Destination $targetDir -Force
               Write-Host "SUCCESS: Copied fallback $($dll -replace '-x64','')"
            } else {
               Write-Host "FATAL: Could not find OpenSSL DLL: $dll"
               exit 1
            }
          }
        }
        
    - name: Copy MDK DLLs
      shell: cmd
      run: |
        if exist "vendor\mdk-sdk\bin\x64\*.dll" (
          echo "Copying MDK DLLs..."
          copy /Y vendor\mdk-sdk\bin\x64\*.dll build\${{ inputs.build_type }}\
        ) else (
          echo "No MDK DLLs found to copy"
        )
        
    - name: List build artifacts
      shell: cmd
      run: |
        echo "Build artifacts:"
        dir /B build\${{ inputs.build_type }}\
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Yantrium-Windows-${{ inputs.build_type }}
        path: |
          build/${{ inputs.build_type }}/Yantrium.exe
          build/${{ inputs.build_type }}/*.dll
          build/${{ inputs.build_type }}/platforms/
          build/${{ inputs.build_type }}/sqldrivers/
          build/${{ inputs.build_type }}/qml/
          build/${{ inputs.build_type }}/QtQuick/
          build/${{ inputs.build_type }}/QtQml/
          build/${{ inputs.build_type }}/Qt5Compat/
        retention-days: 30
        if-no-files-found: warn