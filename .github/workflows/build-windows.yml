name: Build Windows (Manual)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Qt6
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.6.3'
        arch: 'win64_msvc2019_64'
        cache: 'true'
        set-env: 'true'
        modules: 'qt5compat qtshadertools' # Essential for UI and Graphics
        
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.31'
        
    - name: Configure CMake
      shell: cmd
      env:
        TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
        TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
        OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      run: |
        cmake -B build -S . ^
          -G "Visual Studio 17 2022" ^
          -A x64 ^
          -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} ^
          -DTMDB_API_KEY="%TMDB_API_KEY%" ^
          -DTRAKT_CLIENT_ID="%TRAKT_CLIENT_ID%" ^
          -DTRAKT_CLIENT_SECRET="%TRAKT_CLIENT_SECRET%" ^
          -DOMDB_API_KEY="%OMDB_API_KEY%"
          
    - name: Build
      shell: cmd
      run: |
        cmake --build build --config ${{ inputs.build_type }}
        
    - name: Check for MDK SDK Windows binaries
      shell: cmd
      run: |
        if not exist "vendor\mdk-sdk\lib\x64\mdk.lib" (
          echo "Warning: MDK SDK Windows library not found at vendor\mdk-sdk\lib\x64\mdk.lib"
        )
        if not exist "vendor\mdk-sdk\bin\x64" (
          echo "Warning: MDK SDK Windows binaries directory not found at vendor\mdk-sdk\bin\x64"
        )

    # --- NUCLEAR TLS FIX ---
    # This step runs windeployqt AND manually copies the TLS plugins folder
    - name: Deploy Qt dependencies and TLS
      shell: powershell
      run: |
        $buildDir = "build\${{ inputs.build_type }}"
        $exePath = "$buildDir\Yantrium.exe"
        
        if (-not (Test-Path $exePath)) {
          Write-Host "FATAL: Executable not found at $exePath"
          exit 1
        }

        # 1. Run windeployqt
        Write-Host "Running windeployqt..."
        # We explicitly add --network and --tls to force checks
        windeployqt.exe --qmldir resources/qml --network --tls --compiler-runtime $exePath

        # 2. MANUALLY COPY TLS PLUGIN
        # Find where Qt is installed by asking where windeployqt lives
        $windeployqt = Get-Command windeployqt
        $binDir = Split-Path -Parent $windeployqt.Path
        $qtRootDir = Split-Path -Parent $binDir
        $qtPluginsDir = Join-Path $qtRootDir "plugins"
        $qtTlsSrc = Join-Path $qtPluginsDir "tls"
        
        $destTlsDir = Join-Path $buildDir "tls"

        Write-Host "Checking for TLS plugins at: $qtTlsSrc"
        
        if (Test-Path $qtTlsSrc) {
           Write-Host "Found Qt TLS plugins. Copying to $destTlsDir..."
           if (-not (Test-Path $destTlsDir)) {
             New-Item -ItemType Directory -Path $destTlsDir | Out-Null
           }
           Copy-Item -Path "$qtTlsSrc\*" -Destination $destTlsDir -Force -Recurse
           Write-Host "SUCCESS: TLS plugin folder created."
        } else {
           Write-Host "ERROR: Could not find TLS plugins at $qtTlsSrc"
           exit 1
        }

        # 3. Verify the result
        Write-Host "Verifying TLS setup..."
        if (Test-Path "$destTlsDir\qopensslbackend.dll") {
            Write-Host " [OK] qopensslbackend.dll found."
        } else {
            Write-Host " [FAIL] qopensslbackend.dll missing!"
        }

    # --- ROBUST OPENSSL FIX ---
    # Installs OpenSSL 3 and finds the DLLs even if paths change
    - name: Setup and Copy OpenSSL
      shell: powershell
      run: |
        Write-Host "Installing OpenSSL 3 via Chocolatey..."
        choco install openssl --no-progress
        
        # Check both the old (Win64) and new (FireDaemon) paths
        $possiblePaths = @(
          "C:\Program Files\OpenSSL\bin",
          "C:\Program Files\OpenSSL-Win64\bin"
        )
        
        $opensslPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            $opensslPath = $path
            break
          }
        }
        
        if (-not $opensslPath) {
          Write-Host "FATAL: Could not find OpenSSL bin directory."
          exit 1
        }
        
        Write-Host "Found OpenSSL at: $opensslPath"
        $targetDir = "build\${{ inputs.build_type }}"
        
        # Copy using wildcards to match either "libcrypto-3.dll" or "libcrypto-3-x64.dll"
        $libs = Get-ChildItem -Path $opensslPath -Include "libcrypto*.dll", "libssl*.dll" -Recurse
        
        if ($libs) {
          foreach ($lib in $libs) {
            Copy-Item -Path $lib.FullName -Destination $targetDir -Force
            Write-Host "SUCCESS: Copied $($lib.Name)"
          }
        } else {
           Write-Host "FATAL: No libcrypto/libssl DLLs found in $opensslPath"
           exit 1
        }

    - name: Copy SQL plugins
      shell: powershell
      run: |
        Write-Host "Copying SQL plugins..."
        $windeployqt = Get-Command windeployqt -ErrorAction SilentlyContinue
        if (-not $windeployqt) { Write-Host "ERROR: windeployqt not found"; exit 1 }
        
        $qtBinDir = Split-Path -Parent $windeployqt.Path
        $qtRootDir = Split-Path -Parent $qtBinDir
        $sqlPluginsDir = Join-Path $qtRootDir "plugins\sqldrivers"
        
        $sqliteDll = Join-Path $sqlPluginsDir "qsqlite.dll"
        if (Test-Path $sqliteDll) {
          $targetDir = "build\${{ inputs.build_type }}\sqldrivers"
          if (-not (Test-Path $targetDir)) { New-Item -ItemType Directory -Path $targetDir | Out-Null }
          Copy-Item -Path $sqliteDll -Destination $targetDir -Force
          Write-Host "SUCCESS: SQLite plugin copied to $targetDir"
        } else {
          Write-Host "ERROR: qsqlite.dll not found at $sqlPluginsDir"
          exit 1
        }
        
    - name: Copy MDK DLLs
      shell: cmd
      run: |
        if exist "vendor\mdk-sdk\bin\x64\*.dll" (
          echo "Copying MDK DLLs..."
          copy /Y vendor\mdk-sdk\bin\x64\*.dll build\${{ inputs.build_type }}\
        ) else (
          echo "No MDK DLLs found to copy"
        )
        
    - name: List build artifacts
      shell: cmd
      run: |
        echo "Build artifacts:"
        dir /B build\${{ inputs.build_type }}\
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Yantrium-Windows-${{ inputs.build_type }}
        path: |
          build/${{ inputs.build_type }}/Yantrium.exe
          build/${{ inputs.build_type }}/*.dll
          build/${{ inputs.build_type }}/platforms/
          build/${{ inputs.build_type }}/sqldrivers/
          build/${{ inputs.build_type }}/qml/
          build/${{ inputs.build_type }}/QtQuick/
          build/${{ inputs.build_type }}/QtQml/
          build/${{ inputs.build_type }}/Qt5Compat/
          build/${{ inputs.build_type }}/tls/      # <--- IMPORTANT: Includes the TLS plugin folder
        retention-days: 30
        if-no-files-found: warn