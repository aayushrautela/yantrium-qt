name: Build Windows (Manual)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Qt6
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.6.3'
        arch: 'win64_msvc2019_64'
        cache: 'true'
        set-env: 'true'
        modules: 'qt5compat qtshadertools'

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.31'
    
    - name: Install 7-Zip
      shell: powershell
      run: |
        choco install 7zip --no-progress -y
        
    - name: Download MDK SDK
      shell: powershell
      run: |
        $MDK_VERSION = "0.35.0"
        $vendorDir = "vendor\mdk-sdk"
        New-Item -ItemType Directory -Force -Path $vendorDir | Out-Null
        cd $vendorDir
        
        Write-Host "Attempting to download MDK SDK version $MDK_VERSION..."
        
        # Use VS2022 x64 build (matches our build environment)
        $downloadUrl = "https://github.com/wang-bin/mdk-sdk/releases/download/v$MDK_VERSION/mdk-sdk-windows-desktop-vs2022-x64.7z"
        Write-Host "Download URL: $downloadUrl"
        
        $archiveFile = "mdk-sdk.7z"
        
        try {
            Invoke-WebRequest -Uri $downloadUrl -OutFile $archiveFile -UseBasicParsing
            Write-Host "Successfully downloaded MDK SDK"
        } catch {
            Write-Host "Error: Failed to download MDK SDK v$MDK_VERSION from GitHub releases"
            Write-Host "URL attempted: $downloadUrl"
            Write-Host "Error: $_"
            exit 1
        }
        
        Write-Host "Extracting MDK SDK (7z archive)..."
        # Use 7-Zip to extract (choco installs it to Program Files)
        $7zipPath = "${env:ProgramFiles}\7-Zip\7z.exe"
        if (-not (Test-Path $7zipPath)) {
            $7zipPath = "${env:ProgramFiles(x86)}\7-Zip\7z.exe"
        }
        if (-not (Test-Path $7zipPath)) {
            Write-Host "ERROR: 7-Zip not found. Expected at: $7zipPath"
            exit 1
        }
        
        & $7zipPath x $archiveFile -y
        
        Remove-Item $archiveFile -Force
        
        # Handle archives that extract with a root directory (e.g., mdk-sdk-windows-desktop-vs2022-x64/)
        $subdirs = Get-ChildItem -Directory | Where-Object { $_.Name -like "mdk-sdk*" -or $_.Name -like "mdk*" }
        if ($subdirs.Count -eq 1) {
            Write-Host "Archive extracted with root directory, moving contents up..."
            $subdir = $subdirs[0]
            Get-ChildItem -Path $subdir.FullName | Move-Item -Destination . -Force
            Remove-Item $subdir -Force
        }
        
        # Verify essential files exist
        if (-not (Test-Path "include\mdk\Player.h")) {
            Write-Host "Error: MDK SDK extraction failed - include/mdk/Player.h not found"
            Write-Host "Contents of current directory:"
            Get-ChildItem | Select-Object Name, PSIsContainer
            if (Test-Path "include") {
                Write-Host "Contents of include directory:"
                Get-ChildItem "include" -Recurse | Select-Object FullName
            }
            exit 1
        }
        if (-not (Test-Path "lib\x64\mdk.lib") -and -not (Test-Path "lib\mdk.lib")) {
            Write-Host "Error: MDK SDK extraction failed - lib/mdk.lib not found"
            if (Test-Path "lib") {
                Write-Host "Contents of lib directory:"
                Get-ChildItem "lib" -Recurse | Select-Object FullName
            }
            exit 1
        }
        
        Write-Host "MDK SDK downloaded and extracted successfully"
        cd ..\..
    
    # Cache libtorrent build since it takes forever
    - name: Cache vcpkg and libtorrent
      uses: actions/cache@v4
      id: vcpkg-cache
      with:
        path: |
          vcpkg/
          vendor/libtorrent/
        key: vcpkg-libtorrent-${{ runner.os }}-v2

    - name: Build libtorrent with vcpkg
      if: steps.vcpkg-cache.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        echo "Setting up vcpkg..."
        git clone https://github.com/Microsoft/vcpkg.git vcpkg
        cd vcpkg
        .\bootstrap-vcpkg.bat

        echo "Installing libtorrent..."
        .\vcpkg install libtorrent:x64-windows

        echo "Copying libtorrent files to vendor directory..."
        $vendorDir = "..\vendor\libtorrent"
        New-Item -ItemType Directory -Force -Path "$vendorDir\bin\x64" | Out-Null
        New-Item -ItemType Directory -Force -Path "$vendorDir\lib\x64" | Out-Null
        New-Item -ItemType Directory -Force -Path "$vendorDir\include" | Out-Null

        Copy-Item -Path "installed\x64-windows\bin\*.dll" -Destination "$vendorDir\bin\x64\" -Force
        Copy-Item -Path "installed\x64-windows\lib\*.lib" -Destination "$vendorDir\lib\x64\" -Force
        Copy-Item -Path "installed\x64-windows\include\*" -Destination "$vendorDir\include\" -Recurse -Force

        echo "libtorrent setup complete"
        
    # Convert SVG to ICO for Windows icon
    - name: Convert SVG to ICO
      shell: powershell
      run: |
        # Install ImageMagick for SVG to ICO conversion
        choco install imagemagick --no-progress -y
        
        # Create icons directory if it doesn't exist
        $iconDir = "resources\assets\icons"
        if (-not (Test-Path $iconDir)) {
          New-Item -ItemType Directory -Path $iconDir -Force | Out-Null
        }
        
        # Convert SVG to ICO with multiple sizes (16, 32, 48, 64, 128, 256)
        $svgPath = "$iconDir\app_logo.svg"
        $icoPath = "$iconDir\app_logo.ico"
        
        if (Test-Path $svgPath) {
          Write-Host "Converting $svgPath to $icoPath"
          magick $svgPath -define icon:auto-resize=16,32,48,64,128,256 $icoPath
          if (Test-Path $icoPath) {
            Write-Host "Successfully created icon file: $icoPath"
          } else {
            Write-Host "Warning: Icon conversion may have failed"
          }
        } else {
          Write-Host "Warning: SVG file not found at $svgPath"
        }

    # Build the main application
    - name: Configure and build
      shell: cmd
      env:
        TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
        TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
        OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      run: |
        cmake -B build -S . ^
          -G "Visual Studio 17 2022" ^
          -A x64 ^
          -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} ^
          -DTMDB_API_KEY="%TMDB_API_KEY%" ^
          -DTRAKT_CLIENT_ID="%TRAKT_CLIENT_ID%" ^
          -DTRAKT_CLIENT_SECRET="%TRAKT_CLIENT_SECRET%" ^
          -DOMDB_API_KEY="%OMDB_API_KEY%"

        cmake --build build --config ${{ inputs.build_type }}
        
    - name: Check MDK SDK
      shell: powershell
      run: |
        $mdkInclude = "vendor\mdk-sdk\include\mdk\Player.h"
        $mdkLib1 = "vendor\mdk-sdk\lib\x64\mdk.lib"
        $mdkLib2 = "vendor\mdk-sdk\lib\mdk.lib"
        
        if (-not (Test-Path $mdkInclude)) {
          Write-Host "ERROR: MDK SDK header not found at $mdkInclude"
          Write-Host "Contents of vendor\mdk-sdk\include:"
          if (Test-Path "vendor\mdk-sdk\include") {
            Get-ChildItem "vendor\mdk-sdk\include" -Recurse | Select-Object FullName
          }
          exit 1
        }
        
        if (-not (Test-Path $mdkLib1) -and -not (Test-Path $mdkLib2)) {
          Write-Host "ERROR: MDK SDK library not found at either:"
          Write-Host "  - $mdkLib1"
          Write-Host "  - $mdkLib2"
          if (Test-Path "vendor\mdk-sdk\lib") {
            Write-Host "Contents of vendor\mdk-sdk\lib:"
            Get-ChildItem "vendor\mdk-sdk\lib" -Recurse | Select-Object FullName
          }
          exit 1
        }
        
        Write-Host "MDK SDK verification successful"

    - name: Setup OpenSSL
      shell: powershell
      run: |
        echo "Installing OpenSSL..."
        choco install openssl --no-progress

        $possiblePaths = @("C:\Program Files\OpenSSL\bin", "C:\Program Files\OpenSSL-Win64\bin")
        $opensslPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) { $opensslPath = $path; break }
        }

        if (-not $opensslPath) {
          Write-Host "FATAL: Could not find OpenSSL bin directory."
          exit 1
        }

        $targetDir = "build\${{ inputs.build_type }}"
        $libs = Get-ChildItem -Path $opensslPath -Include "libcrypto*.dll", "libssl*.dll" -Recurse

        if ($libs) {
          foreach ($lib in $libs) {
            Copy-Item -Path $lib.FullName -Destination $targetDir -Force
          }
        } else {
          Write-Host "FATAL: No libcrypto/libssl DLLs found in $opensslPath"
          exit 1
        }

    # Package Qt libraries and plugins
    - name: Deploy Qt
      shell: powershell
      run: |
        $buildDir = "build\${{ inputs.build_type }}"
        $exePath = "$buildDir\Yantrium.exe"

        if (-not (Test-Path $exePath)) {
          Write-Host "FATAL: Executable not found at $exePath"
          exit 1
        }

        Write-Host "Running windeployqt..."
        # Fixed: Removed --imageformats --sql --network (auto-detected in Qt6)
        windeployqt.exe --verbose 2 --qmldir resources/qml --compiler-runtime $exePath

    - name: Copy Image Format Dependency DLLs
      shell: powershell
      run: |
        $buildDir = "build\${{ inputs.build_type }}"
        $windeployqt = Get-Command windeployqt
        $qtBinDir = Split-Path -Parent $windeployqt.Path
        
        Write-Host "Qt bin directory: $qtBinDir"
        
        # Copy all lib*.dll files from Qt bin directory
        # These are third-party libraries needed by image format plugins
        $libDlls = Get-ChildItem -Path $qtBinDir -Filter "lib*.dll" -ErrorAction SilentlyContinue
        if ($libDlls) {
            $copiedCount = 0
            foreach ($dll in $libDlls) {
                $destPath = Join-Path $buildDir $dll.Name
                if (-not (Test-Path $destPath)) {
                    Copy-Item -Path $dll.FullName -Destination $buildDir -Force
                    Write-Host "Copied: $($dll.Name)"
                    $copiedCount++
                }
            }
            Write-Host "Successfully copied $copiedCount image format dependency DLL(s)."
        } else {
            Write-Host "Warning: No lib*.dll files found in Qt bin directory"
        }
        
    # Copy MDK and libtorrent runtime libraries
    - name: Copy dependencies
      shell: cmd
      run: |
        if exist "vendor\mdk-sdk\bin\x64\*.dll" copy /Y vendor\mdk-sdk\bin\x64\*.dll build\${{ inputs.build_type }}\
        if exist "vendor\libtorrent\bin\x64\*.dll" copy /Y vendor\libtorrent\bin\x64\*.dll build\${{ inputs.build_type }}\
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Yantrium-Windows-${{ inputs.build_type }}
        path: |
          build/${{ inputs.build_type }}/Yantrium.exe
          build/${{ inputs.build_type }}/*.dll
          build/${{ inputs.build_type }}/platforms/
          build/${{ inputs.build_type }}/sqldrivers/
          build/${{ inputs.build_type }}/imageformats/
          build/${{ inputs.build_type }}/iconengines/
          build/${{ inputs.build_type }}/qml/
          build/${{ inputs.build_type }}/QtQuick/
          build/${{ inputs.build_type }}/QtQml/
          build/${{ inputs.build_type }}/Qt5Compat/
          build/${{ inputs.build_type }}/tls/
        retention-days: 30
        if-no-files-found: warn