app-id: org.yantrium.Yantrium
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
command: yantrium
finish-args:
  - --share=network
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --filesystem=home
  - --filesystem=xdg-download
  - --filesystem=xdg-videos
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-data/yantrium:create

modules:
  - name: mdk-sdk
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib
      - mkdir -p /app/include
      - cp -r include/* /app/include/ 2>/dev/null || true
      - |
        # Copy libraries from amd64 or x86_64 directory (whichever exists)
        if [ -d lib/amd64 ]; then
          cp -r lib/amd64/*.so* /app/lib/ 2>/dev/null || true
        elif [ -d lib/x86_64 ]; then
          cp -r lib/x86_64/*.so* /app/lib/ 2>/dev/null || true
        elif [ -d lib ]; then
          # Some archives might extract directly to lib/
          cp -r lib/*.so* /app/lib/ 2>/dev/null || true
        fi
      - |
        # Set up library symlinks if needed
        if [ -f /app/lib/libmdk.so.0 ]; then
          ln -sf libmdk.so.0 /app/lib/libmdk.so || true
        fi
    sources:
      - type: dir
        path: vendor/mdk-sdk

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=system,filesystem,thread,chrono,date_time,random
      - ./b2 -j$(nproc) variant=release link=shared threading=multi install
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.84.0/source/boost_1_84_0.tar.bz2
        sha256: cc4b893acf645c9d4b698e9a0f08ca8846aa5d6c68275c14c3e7949c24109454

  - name: libtorrent-rasterbar
    buildsystem: cmake-ninja
    build-options:
      cflags: -O2 -g
      cxxflags: -O2 -g
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
      - -DCMAKE_PREFIX_PATH=/app
      - -DBOOST_ROOT=/app
      - -DBoost_INCLUDE_DIR=/app/include
      - -DBoost_LIBRARY_DIR=/app/lib
      - -DBoost_NO_BOOST_CMAKE=ON
      - -Ddeprecated-functions=OFF
      - -Dpython-bindings=OFF
      - -Dpython-egg-info=OFF
    sources:
      - type: git
        url: https://github.com/arvidn/libtorrent.git
        tag: v2.0.10

  - name: yantrium
    buildsystem: cmake-ninja
    build-options:
      cflags: -O2 -g
      cxxflags: -O2 -g
      ldflags: -Wl,-rpath=/app/lib
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_PREFIX_PATH=/usr/lib64/cmake
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
      - -DCMAKE_INSTALL_BINDIR=/app/bin
      - -DTMDB_API_KEY=${TMDB_API_KEY}
      - -DTRAKT_CLIENT_ID=${TRAKT_CLIENT_ID}
      - -DTRAKT_CLIENT_SECRET=${TRAKT_CLIENT_SECRET}
      - -DOMDB_API_KEY=${OMDB_API_KEY}
    post-install:
      # 1. Verify MDK libs
      - |
        if [ ! -f /app/lib/libmdk.so ] && [ ! -f /app/lib/libmdk.so.0 ]; then
          echo "Warning: MDK libraries not found in /app/lib"
        fi

      # 2. Rename executable
      - |
        if [ -f /app/bin/Yantrium ]; then
          mv /app/bin/Yantrium /app/bin/yantrium
        fi

      # 3. Install Desktop File
      - |
        mkdir -p /app/share/applications
        if [ -f org.yantrium.Yantrium.desktop ]; then
          cp org.yantrium.Yantrium.desktop /app/share/applications/
        else
          echo "ERROR: org.yantrium.Yantrium.desktop file missing from source root!"
          exit 1
        fi

      # 4. Install Icons (Standardized)
      - |
        ICON_SRC="resources/assets/icons/app_logo.svg"
        APP_ID="org.yantrium.Yantrium"
        
        if [ -f "$ICON_SRC" ]; then
          # Install Scalable SVG (The most important one for GNOME)
          mkdir -p /app/share/icons/hicolor/scalable/apps
          cp "$ICON_SRC" "/app/share/icons/hicolor/scalable/apps/${APP_ID}.svg"
          echo "Installed scalable icon as ${APP_ID}.svg"
          
          # Generate PNGs for compatibility
          ICON_SIZES="16 32 48 64 128 256"
          for size in $ICON_SIZES; do
            mkdir -p "/app/share/icons/hicolor/${size}x${size}/apps"
            
            # Try using rsvg-convert (Standard in most SDKs)
            if command -v rsvg-convert >/dev/null 2>&1; then
              rsvg-convert -w $size -h $size "$ICON_SRC" -o "/app/share/icons/hicolor/${size}x${size}/apps/${APP_ID}.png"
            # Fallback to ImageMagick convert
            elif command -v convert >/dev/null 2>&1; then
              convert -background none -resize ${size}x${size} "$ICON_SRC" "/app/share/icons/hicolor/${size}x${size}/apps/${APP_ID}.png"
            else
              echo "Warning: No icon converter tool found. Only SVG installed."
            fi
          done
        else
          echo "Warning: Icon file not found at $ICON_SRC"
        fi
    sources:
      - type: dir
        path: .
