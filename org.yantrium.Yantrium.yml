app-id: org.yantrium.Yantrium
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
command: yantrium
icon: resources/assets/icons/app_logo.svg
finish-args:
  - --share=network
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --filesystem=home
  - --filesystem=xdg-download
  - --filesystem=xdg-videos
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-data/yantrium:create

modules:
  - name: mdk-sdk
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib
      - mkdir -p /app/include
      - cp -r include/* /app/include/ 2>/dev/null || true
      - |
        # Copy libraries from amd64 or x86_64 directory (whichever exists)
        if [ -d lib/amd64 ]; then
          cp -r lib/amd64/*.so* /app/lib/ 2>/dev/null || true
        elif [ -d lib/x86_64 ]; then
          cp -r lib/x86_64/*.so* /app/lib/ 2>/dev/null || true
        elif [ -d lib ]; then
          # Some archives might extract directly to lib/
          cp -r lib/*.so* /app/lib/ 2>/dev/null || true
        fi
      - |
        # Set up library symlinks if needed
        if [ -f /app/lib/libmdk.so.0 ]; then
          ln -sf libmdk.so.0 /app/lib/libmdk.so || true
        fi
    sources:
      - type: dir
        path: vendor/mdk-sdk

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=system,filesystem,thread,chrono,date_time,random
      - ./b2 -j$(nproc) variant=release link=shared threading=multi install
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.84.0/source/boost_1_84_0.tar.bz2
        sha256: cc4b893acf645c9d4b698e9a0f08ca8846aa5d6c68275c14c3e7949c24109454

  - name: libtorrent-rasterbar
    buildsystem: cmake-ninja
    build-options:
      cflags: -O2 -g
      cxxflags: -O2 -g
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
      - -DCMAKE_PREFIX_PATH=/app
      - -DBOOST_ROOT=/app
      - -DBoost_INCLUDE_DIR=/app/include
      - -DBoost_LIBRARY_DIR=/app/lib
      - -DBoost_NO_BOOST_CMAKE=ON
      - -Ddeprecated-functions=OFF
      - -Dpython-bindings=OFF
      - -Dpython-egg-info=OFF
    sources:
      - type: git
        url: https://github.com/arvidn/libtorrent.git
        tag: v2.0.10

  - name: yantrium
    buildsystem: cmake-ninja
    build-options:
      cflags: -O2 -g
      cxxflags: -O2 -g
      ldflags: -Wl,-rpath=/app/lib
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_PREFIX_PATH=/usr/lib64/cmake
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
      - -DCMAKE_INSTALL_BINDIR=/app/bin
      - -DTMDB_API_KEY=${TMDB_API_KEY}
      - -DTRAKT_CLIENT_ID=${TRAKT_CLIENT_ID}
      - -DTRAKT_CLIENT_SECRET=${TRAKT_CLIENT_SECRET}
      - -DOMDB_API_KEY=${OMDB_API_KEY}
    post-install:
      - |
        # MDK libraries should already be in /app/lib from the mdk-sdk module
        # Verify they exist
        if [ ! -f /app/lib/libmdk.so ] && [ ! -f /app/lib/libmdk.so.0 ]; then
          echo "Warning: MDK libraries not found in /app/lib"
        fi
      - |
        # Rename executable to lowercase
        if [ -f /app/bin/Yantrium ]; then
          mv /app/bin/Yantrium /app/bin/yantrium
        fi
      - |
        # Copy libtorrent libraries (built by libtorrent-rasterbar module)
        if [ -f /app/lib/libtorrent-rasterbar.so ]; then
          echo "libtorrent-rasterbar.so found in /app/lib"
        fi
      - |
        # Install desktop file
        mkdir -p /app/share/applications
        if [ -f org.yantrium.Yantrium.desktop ]; then
          cp org.yantrium.Yantrium.desktop /app/share/applications/
          echo "Desktop file installed"
        else
          echo "Warning: Desktop file not found"
        fi
      - |
        # Install icons in multiple sizes for better desktop environment compatibility
        if [ -f resources/assets/icons/app_logo.svg ]; then
          # Install scalable SVG icon
          mkdir -p /app/share/icons/hicolor/scalable/apps
          cp resources/assets/icons/app_logo.svg /app/share/icons/hicolor/scalable/apps/org.yantrium.Yantrium.svg
          echo "Scalable icon installed"
          
          # Generate and install fixed-size PNG icons from SVG
          # Using rsvg-convert (librsvg) which is available in KDE SDK
          ICON_SIZES="16 32 48 64 128 256"
          for size in $ICON_SIZES; do
            mkdir -p /app/share/icons/hicolor/${size}x${size}/apps
            if command -v rsvg-convert >/dev/null 2>&1; then
              rsvg-convert -w $size -h $size resources/assets/icons/app_logo.svg \
                -o /app/share/icons/hicolor/${size}x${size}/apps/org.yantrium.Yantrium.png
              echo "Generated ${size}x${size} icon"
            elif command -v convert >/dev/null 2>&1; then
              # Fallback to ImageMagick if available
              convert -background none -resize ${size}x${size} resources/assets/icons/app_logo.svg \
                /app/share/icons/hicolor/${size}x${size}/apps/org.yantrium.Yantrium.png
              echo "Generated ${size}x${size} icon (ImageMagick)"
            else
              echo "Warning: No SVG converter found (rsvg-convert or ImageMagick), skipping ${size}x${size} icon"
            fi
          done
          
          echo "Icons installed successfully"
        else
          echo "Warning: Icon file not found at resources/assets/icons/app_logo.svg"
        fi
    sources:
      - type: dir
        path: .
      - type: file
        path: resources/assets/icons/app_logo.svg
